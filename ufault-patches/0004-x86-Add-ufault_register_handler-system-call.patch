From c851f04ffa56c74d6f9898eeee7cb05ba284032b Mon Sep 17 00:00:00 2001
From: beviu <contact@beviu.com>
Date: Fri, 25 Jul 2025 13:33:10 +0200
Subject: [PATCH 4/4] x86: Add ufault_register_handler system call

---
 arch/x86/entry/syscalls/syscall_64.tbl |  1 +
 arch/x86/include/asm/entry-common.h    |  4 ++++
 arch/x86/include/asm/processor.h       |  3 +++
 arch/x86/include/asm/ufault.h          | 11 +++++++++++
 arch/x86/kernel/Makefile               |  1 +
 arch/x86/kernel/ufault.c               | 19 +++++++++++++++++++
 6 files changed, 39 insertions(+)
 create mode 100644 arch/x86/include/asm/ufault.h
 create mode 100644 arch/x86/kernel/ufault.c

diff --git a/arch/x86/entry/syscalls/syscall_64.tbl b/arch/x86/entry/syscalls/syscall_64.tbl
index 4ca4f4a3d60c..4c41cc90073e 100644
--- a/arch/x86/entry/syscalls/syscall_64.tbl
+++ b/arch/x86/entry/syscalls/syscall_64.tbl
@@ -382,6 +382,7 @@
 477	common	uintr_register_self	sys_uintr_register_self
 478	common	uintr_alt_stack		sys_uintr_alt_stack
 479	common	uintr_ipi_fd		sys_uintr_ipi_fd
+480	common	ufault_register_handler	sys_ufault_register_handler
 
 #
 # Due to a historical design error, certain syscalls are numbered differently
diff --git a/arch/x86/include/asm/entry-common.h b/arch/x86/include/asm/entry-common.h
index cb42f592a8f0..1205ff7e3452 100644
--- a/arch/x86/include/asm/entry-common.h
+++ b/arch/x86/include/asm/entry-common.h
@@ -9,6 +9,7 @@
 #include <asm/io_bitmap.h>
 #include <asm/fpu/api.h>
 #include <asm/uintr.h>
+#include <asm/ufault.h>
 
 /* Check that the stack and regs on entry from user mode are sane. */
 static __always_inline void arch_enter_from_user_mode(struct pt_regs *regs)
@@ -61,6 +62,9 @@ static inline void arch_exit_to_user_mode_prepare(struct pt_regs *regs,
 	if (cpu_feature_enabled(X86_FEATURE_UINTR))
 		switch_uintr_return();
 
+	if (cpu_feature_enabled(X86_FEATURE_UFAULT))
+		switch_ufault_return();
+
 #ifdef CONFIG_COMPAT
 	/*
 	 * Compat syscalls set TS_COMPAT.  Make sure we clear it before
diff --git a/arch/x86/include/asm/processor.h b/arch/x86/include/asm/processor.h
index 0859583f7192..fdade9df13a3 100644
--- a/arch/x86/include/asm/processor.h
+++ b/arch/x86/include/asm/processor.h
@@ -533,6 +533,9 @@ struct thread_struct {
 	struct uintr_upid_ctx	*upid_ctx;
 #endif
 
+	unsigned long		ufault_handler;
+	unsigned int		ufault_enabled:1;
+
 	/*
 	 * Protection Keys Register for Userspace.  Loaded immediately on
 	 * context switch. Store it in thread_struct to avoid a lookup in
diff --git a/arch/x86/include/asm/ufault.h b/arch/x86/include/asm/ufault.h
new file mode 100644
index 000000000000..481e2c225a86
--- /dev/null
+++ b/arch/x86/include/asm/ufault.h
@@ -0,0 +1,11 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+#ifndef _ASM_X86_UFAULT_H
+#define _ASM_X86_UFAULT_H
+
+#ifdef CONFIG_X86_USER_FAULTS
+
+void switch_ufault_return(void);
+
+#endif /* CONFIG_X86_USER_FAULTS */
+
+#endif /* _ASM_X86_UFAULT_H */
diff --git a/arch/x86/kernel/Makefile b/arch/x86/kernel/Makefile
index 796db2497075..3685f17db777 100644
--- a/arch/x86/kernel/Makefile
+++ b/arch/x86/kernel/Makefile
@@ -132,6 +132,7 @@ obj-$(CONFIG_PERF_EVENTS)		+= perf_regs.o
 obj-$(CONFIG_TRACING)			+= tracepoint.o
 obj-$(CONFIG_SCHED_MC_PRIO)		+= itmt.o
 obj-$(CONFIG_X86_USER_INTERRUPTS)	+= uintr.o
+obj-$(CONFIG_X86_USER_FAULTS)		+= ufault.o
 obj-$(CONFIG_X86_UMIP)			+= umip.o
 
 obj-$(CONFIG_UNWINDER_ORC)		+= unwind_orc.o
diff --git a/arch/x86/kernel/ufault.c b/arch/x86/kernel/ufault.c
new file mode 100644
index 000000000000..82b6cb8ad674
--- /dev/null
+++ b/arch/x86/kernel/ufault.c
@@ -0,0 +1,19 @@
+#include <linux/syscalls.h>
+
+#include <asm/ufault.h>
+
+SYSCALL_DEFINE2(ufault_register_handler, long, handler, int, flags)
+{
+	if (flags)
+		return -EINVAL;
+
+	current->thread.ufault_handler = handler;
+
+	return 0;
+}
+
+void switch_ufault_return(void)
+{
+	wrmsrl(MSR_IA32_UFAULT_ENABLE, current->thread.ufault_enabled);
+	wrmsrl(MSR_IA32_UFAULT_HANDLER, current->thread.ufault_handler);
+}
-- 
2.51.0

