From c0bb8edb800b0a4c8293d4d91373c80aac110bd5 Mon Sep 17 00:00:00 2001
From: beviu <contact@beviu.com>
Date: Fri, 25 Jul 2025 13:33:10 +0200
Subject: [PATCH 2/2] ufault: Add ufault_{,un}register_handler system calls

---
 arch/x86/entry/syscalls/syscall_64.tbl |  2 ++
 arch/x86/kernel/Makefile               |  1 +
 arch/x86/kernel/ufault.c               | 34 ++++++++++++++++++++++++++
 3 files changed, 37 insertions(+)
 create mode 100644 arch/x86/kernel/ufault.c

diff --git a/arch/x86/entry/syscalls/syscall_64.tbl b/arch/x86/entry/syscalls/syscall_64.tbl
index 4ca4f4a3d60c..08a4af1a0325 100644
--- a/arch/x86/entry/syscalls/syscall_64.tbl
+++ b/arch/x86/entry/syscalls/syscall_64.tbl
@@ -382,6 +382,8 @@
 477	common	uintr_register_self	sys_uintr_register_self
 478	common	uintr_alt_stack		sys_uintr_alt_stack
 479	common	uintr_ipi_fd		sys_uintr_ipi_fd
+480 common	ufault_register_handler	sys_ufault_register_handler
+481 common	ufault_unregister_handler	sys_ufault_unregister_handler
 
 #
 # Due to a historical design error, certain syscalls are numbered differently
diff --git a/arch/x86/kernel/Makefile b/arch/x86/kernel/Makefile
index 796db2497075..ba830238261f 100644
--- a/arch/x86/kernel/Makefile
+++ b/arch/x86/kernel/Makefile
@@ -149,4 +149,5 @@ ifeq ($(CONFIG_X86_64),y)
 
 	obj-$(CONFIG_MMCONF_FAM10H)	+= mmconf-fam10h_64.o
 	obj-y				+= vsmp_64.o
+	obj-y				+= ufault.o
 endif
diff --git a/arch/x86/kernel/ufault.c b/arch/x86/kernel/ufault.c
new file mode 100644
index 000000000000..fc5bcb34f8b2
--- /dev/null
+++ b/arch/x86/kernel/ufault.c
@@ -0,0 +1,34 @@
+#include <linux/syscalls.h>
+
+SYSCALL_DEFINE2(ufault_register_handler, long, handler, int, flags)
+{
+	void *xstate;
+
+	if (flags)
+		return -EINVAL;
+
+	xstate = start_update_xsave_msrs(0);
+
+	xsave_wrmsrl(xstate, MSR_IA32_UFAULT_HANDLER, handler);
+	xsave_wrmsrl(xstate, MSR_IA32_UFAULT_ENABLE, 1);
+
+	end_update_xsave_msrs();
+
+	return 0;
+}
+
+SYSCALL_DEFINE1(ufault_unregister_handler, int, flags)
+{
+	void *xstate;
+
+	if (flags)
+		return -EINVAL;
+
+	xstate = start_update_xsave_msrs(0);
+
+	xsave_wrmsrl(xstate, MSR_IA32_UFAULT_ENABLE, 0);
+
+	end_update_xsave_msrs();
+
+	return 0;
+}
-- 
2.51.0

