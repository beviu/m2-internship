From 30f7827056cc97599f31c1ed29333ba554b798f9 Mon Sep 17 00:00:00 2001
From: beviu <contact@beviu.com>
Date: Fri, 14 Nov 2025 11:36:18 +0100
Subject: [PATCH 19/28] x86/ufault: add user fault defines and instructions

---
 arch/x86/include/asm/cpufeatures.h          |  1 +
 arch/x86/include/asm/msr-index.h            |  2 ++
 arch/x86/include/asm/ufault.h               | 26 +++++++++++++++++++++
 arch/x86/include/uapi/asm/processor-flags.h |  2 ++
 4 files changed, 31 insertions(+)
 create mode 100644 arch/x86/include/asm/ufault.h

diff --git a/arch/x86/include/asm/cpufeatures.h b/arch/x86/include/asm/cpufeatures.h
index c74339c398e8..f7d6a0a54b3a 100644
--- a/arch/x86/include/asm/cpufeatures.h
+++ b/arch/x86/include/asm/cpufeatures.h
@@ -422,6 +422,7 @@
 #define X86_FEATURE_AVX512_4FMAPS	(18*32+ 3) /* "avx512_4fmaps" AVX-512 Multiply Accumulation Single precision */
 #define X86_FEATURE_FSRM		(18*32+ 4) /* "fsrm" Fast Short Rep Mov */
 #define X86_FEATURE_UINTR		(18*32+ 5) /* User Interrupts support */
+#define X86_FEATURE_UFAULT		(18*32+ 6) /* User Faults support */
 #define X86_FEATURE_AVX512_VP2INTERSECT (18*32+ 8) /* "avx512_vp2intersect" AVX-512 Intersect for D/Q */
 #define X86_FEATURE_SRBDS_CTRL		(18*32+ 9) /* SRBDS mitigation MSR available */
 #define X86_FEATURE_MD_CLEAR		(18*32+10) /* "md_clear" VERW clears CPU buffers */
diff --git a/arch/x86/include/asm/msr-index.h b/arch/x86/include/asm/msr-index.h
index b9065632fb93..92b90aa2a191 100644
--- a/arch/x86/include/asm/msr-index.h
+++ b/arch/x86/include/asm/msr-index.h
@@ -575,6 +575,8 @@
 #define MSR_IA32_UINTR_PD		0x989
 #define MSR_IA32_UINTR_TT		0x98a
 
+#define MSR_IA32_UFAULT_HANDLER		0x99e
+
 /* CPUID.6.EAX */
 #define HWP_BASE_BIT			(1<<7)
 #define HWP_NOTIFICATIONS_BIT		(1<<8)
diff --git a/arch/x86/include/asm/ufault.h b/arch/x86/include/asm/ufault.h
new file mode 100644
index 000000000000..0f43b28fb71d
--- /dev/null
+++ b/arch/x86/include/asm/ufault.h
@@ -0,0 +1,26 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+#ifndef _ASM_X86_UFAULT_H
+#define _ASM_X86_UFAULT_H
+
+#include <linux/types.h>
+
+static __always_inline bool testuf(void)
+{
+	bool uff;
+
+	asm volatile(".long 0xe9010ff3" : "=@ccc"(uff) :: "cc");
+
+	return uff;
+}
+
+static __always_inline void cluf(void)
+{
+	asm volatile(".long 0xea010ff3" ::: "memory");
+}
+
+static __always_inline void stuf(void)
+{
+	asm volatile(".long 0xeb010ff3" ::: "memory");
+}
+
+#endif /* _ASM_X86_UFAULT_H */
diff --git a/arch/x86/include/uapi/asm/processor-flags.h b/arch/x86/include/uapi/asm/processor-flags.h
index 106e04ac96a1..a588cc064952 100644
--- a/arch/x86/include/uapi/asm/processor-flags.h
+++ b/arch/x86/include/uapi/asm/processor-flags.h
@@ -138,6 +138,8 @@
 #define X86_CR4_CET		_BITUL(X86_CR4_CET_BIT)
 #define X86_CR4_UINTR_BIT	25 /* enable User Interrupts support */
 #define X86_CR4_UINTR		_BITUL(X86_CR4_UINTR_BIT)
+#define X86_CR4_UFAULT_BIT	26 /* enable User Fault support */
+#define X86_CR4_UFAULT		_BITUL(X86_CR4_UFAULT_BIT)
 #define X86_CR4_LASS_BIT	27 /* enable Linear Address Space Separation support */
 #define X86_CR4_LASS		_BITUL(X86_CR4_LASS_BIT)
 #define X86_CR4_LAM_SUP_BIT	28 /* LAM for supervisor pointers */
-- 
2.52.0

