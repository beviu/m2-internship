From 3b61ffc3ccf479100a3c047198398ba8d0db4cdd Mon Sep 17 00:00:00 2001
From: beviu <contact@beviu.com>
Date: Tue, 20 Jan 2026 13:04:10 +0100
Subject: [PATCH 28/28] x86/cpu: add Gem5 build option

---
 arch/x86/Kconfig.cpu         | 5 +++++
 arch/x86/kernel/cpu/common.c | 4 +++-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/arch/x86/Kconfig.cpu b/arch/x86/Kconfig.cpu
index f928cf6e3252..132257b84dec 100644
--- a/arch/x86/Kconfig.cpu
+++ b/arch/x86/Kconfig.cpu
@@ -281,6 +281,11 @@ config X86_GENERIC
 	  This is really intended for distributors who need more
 	  generic optimizations.
 
+config X86_GEM5
+	bool "Gem5 kernel"
+	help
+	  Build a kernel for running under Gem5.
+
 #
 # Define implied options from the CPU selection here
 config X86_INTERNODE_CACHE_SHIFT
diff --git a/arch/x86/kernel/cpu/common.c b/arch/x86/kernel/cpu/common.c
index f400ef6a365f..084beefe128e 100644
--- a/arch/x86/kernel/cpu/common.c
+++ b/arch/x86/kernel/cpu/common.c
@@ -413,7 +413,9 @@ static void setup_uintr(struct cpuinfo_x86 *c)
 		goto clear_uintr_cap;
 	}
 
-	cr4_set_bits(X86_CR4_UINTR);
+	/* Gem5 boots the kernel under KVM, and KVM does not know about this bit. */
+	if (!IS_ENABLED(CONFIG_X86_GEM5))
+		cr4_set_bits(X86_CR4_UINTR);
 	pr_info_once("x86: User Interrupts (UINTR) enabled\n");
 
 	return;
-- 
2.52.0

