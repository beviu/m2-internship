From bb2d7e2ecb37082b5313c35e616a9a47ed3ed2c2 Mon Sep 17 00:00:00 2001
From: beviu <contact@beviu.com>
Date: Fri, 14 Nov 2025 11:36:18 +0100
Subject: [PATCH 21/28] x86/ufault: add "noufault" kernel param to force
 disable user faults

---
 Documentation/admin-guide/kernel-parameters.txt |  2 ++
 arch/x86/kernel/cpu/common.c                    | 16 ++++++++++++++++
 2 files changed, 18 insertions(+)

diff --git a/Documentation/admin-guide/kernel-parameters.txt b/Documentation/admin-guide/kernel-parameters.txt
index e0a4c816b333..4ebd927d9355 100644
--- a/Documentation/admin-guide/kernel-parameters.txt
+++ b/Documentation/admin-guide/kernel-parameters.txt
@@ -4396,6 +4396,8 @@ Kernel parameters
 
 	nocache		[ARM,EARLY]
 
+	noufault	[X86-64] Disables User Fault support.
+
 	nouintr		[X86-64] Disables User Interrupts support.
 
 	no_console_suspend
diff --git a/arch/x86/kernel/cpu/common.c b/arch/x86/kernel/cpu/common.c
index 2cd9949a7f7f..5978bebcfdbd 100644
--- a/arch/x86/kernel/cpu/common.c
+++ b/arch/x86/kernel/cpu/common.c
@@ -429,6 +429,22 @@ static void setup_uintr(struct cpuinfo_x86 *c)
 	cr4_clear_bits(X86_CR4_UINTR);
 }
 
+static __init int setup_disable_ufault(char *arg)
+{
+	/* No additional arguments expected */
+	if (strlen(arg))
+		return 0;
+
+	/* Do not emit a message if the feature is not present. */
+	if (!boot_cpu_has(X86_FEATURE_UFAULT))
+		return 1;
+
+	setup_clear_cpu_cap(X86_FEATURE_UFAULT);
+	pr_info_once("x86: 'noufault' specified, User Fault support disabled\n");
+	return 1;
+}
+__setup("noufault", setup_disable_ufault);
+
 static void setup_ufault(struct cpuinfo_x86 *c)
 {
 	if (!cpu_feature_enabled(X86_FEATURE_UFAULT) ||
-- 
2.52.0

