From 8a9f2176cafa0f2d11c9c53d5917deed8462f007 Mon Sep 17 00:00:00 2001
From: beviu <contact@beviu.com>
Date: Fri, 14 Nov 2025 11:36:18 +0100
Subject: [PATCH 22/29] x86/ufault: add "noufault" kernel param to force
 disable user faults

---
 Documentation/admin-guide/kernel-parameters.txt |  2 ++
 arch/x86/kernel/cpu/common.c                    | 16 ++++++++++++++++
 2 files changed, 18 insertions(+)

diff --git a/Documentation/admin-guide/kernel-parameters.txt b/Documentation/admin-guide/kernel-parameters.txt
index 37ae1d678a83..6b70078a947c 100644
--- a/Documentation/admin-guide/kernel-parameters.txt
+++ b/Documentation/admin-guide/kernel-parameters.txt
@@ -3540,6 +3540,8 @@
 
 	nofsgsbase	[X86] Disables FSGSBASE instructions.
 
+	noufault	[X86-64] Disables User Fault support.
+
 	nouintr		[X86-64] Disables User Interrupts support.
 
 	no_console_suspend
diff --git a/arch/x86/kernel/cpu/common.c b/arch/x86/kernel/cpu/common.c
index 84714f475397..4815405a8da2 100644
--- a/arch/x86/kernel/cpu/common.c
+++ b/arch/x86/kernel/cpu/common.c
@@ -434,6 +434,22 @@ static void setup_uintr(struct cpuinfo_x86 *c)
 	cr4_clear_bits(X86_CR4_UINTR);
 }
 
+static __init int setup_disable_ufault(char *arg)
+{
+	/* No additional arguments expected */
+	if (strlen(arg))
+		return 0;
+
+	/* Do not emit a message if the feature is not present. */
+	if (!boot_cpu_has(X86_FEATURE_UFAULT))
+		return 1;
+
+	setup_clear_cpu_cap(X86_FEATURE_UFAULT);
+	pr_info_once("x86: 'noufault' specified, User Fault support disabled\n");
+	return 1;
+}
+__setup("noufault", setup_disable_ufault);
+
 static void setup_ufault(struct cpuinfo_x86 *c)
 {
 	if (!cpu_feature_enabled(X86_FEATURE_UFAULT) ||
-- 
2.52.0

