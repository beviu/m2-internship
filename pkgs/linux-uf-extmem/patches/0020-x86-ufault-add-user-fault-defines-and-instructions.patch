From 9fa78229007d4273b170fd56157d7efe5976bfdc Mon Sep 17 00:00:00 2001
From: beviu <contact@beviu.com>
Date: Fri, 14 Nov 2025 11:36:18 +0100
Subject: [PATCH 20/34] x86/ufault: add user fault defines and instructions

---
 arch/x86/include/asm/cpufeatures.h          |  1 +
 arch/x86/include/asm/msr-index.h            |  2 ++
 arch/x86/include/asm/ufault.h               | 26 +++++++++++++++++++++
 arch/x86/include/uapi/asm/processor-flags.h |  2 ++
 4 files changed, 31 insertions(+)
 create mode 100644 arch/x86/include/asm/ufault.h

diff --git a/arch/x86/include/asm/cpufeatures.h b/arch/x86/include/asm/cpufeatures.h
index a970819bf77e..2f2c0a828554 100644
--- a/arch/x86/include/asm/cpufeatures.h
+++ b/arch/x86/include/asm/cpufeatures.h
@@ -391,6 +391,7 @@
 #define X86_FEATURE_AVX512_4FMAPS	(18*32+ 3) /* AVX-512 Multiply Accumulation Single precision */
 #define X86_FEATURE_FSRM		(18*32+ 4) /* Fast Short Rep Mov */
 #define X86_FEATURE_UINTR		(18*32+ 5) /* User Interrupts support */
+#define X86_FEATURE_UFAULT		(18*32+ 6) /* User Faults support */
 #define X86_FEATURE_AVX512_VP2INTERSECT (18*32+ 8) /* AVX-512 Intersect for D/Q */
 #define X86_FEATURE_SRBDS_CTRL		(18*32+ 9) /* "" SRBDS mitigation MSR available */
 #define X86_FEATURE_MD_CLEAR		(18*32+10) /* VERW clears CPU buffers */
diff --git a/arch/x86/include/asm/msr-index.h b/arch/x86/include/asm/msr-index.h
index a419fc76b4fc..e258b1df7ebd 100644
--- a/arch/x86/include/asm/msr-index.h
+++ b/arch/x86/include/asm/msr-index.h
@@ -458,6 +458,8 @@
 #define MSR_IA32_UINTR_PD		0x989
 #define MSR_IA32_UINTR_TT		0x98a
 
+#define MSR_IA32_UFAULT_HANDLER		0x99e
+
 /* CPUID.6.EAX */
 #define HWP_BASE_BIT			(1<<7)
 #define HWP_NOTIFICATIONS_BIT		(1<<8)
diff --git a/arch/x86/include/asm/ufault.h b/arch/x86/include/asm/ufault.h
new file mode 100644
index 000000000000..9752e79f7a77
--- /dev/null
+++ b/arch/x86/include/asm/ufault.h
@@ -0,0 +1,26 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+#ifndef _ASM_X86_UFAULT_H
+#define _ASM_X86_UFAULT_H
+
+#include <linux/types.h>
+
+static __always_inline bool testuf(void)
+{
+	bool uff;
+
+	asm volatile(".long 0xe9010ff3" : "=@ccc"(uff) :: "cc");
+
+	return uff;
+}
+
+static __always_inline void cluf(void)
+{
+	asm volatile(".long 0xea010ff3" ::: "memory");
+}
+
+static __always_inline void stuf(void)
+{
+	asm volatile(".long 0xea010ff3" ::: "memory");
+}
+
+#endif /* _ASM_X86_UFAULT_H */
diff --git a/arch/x86/include/uapi/asm/processor-flags.h b/arch/x86/include/uapi/asm/processor-flags.h
index c1cb1e39f561..48bf59cea565 100644
--- a/arch/x86/include/uapi/asm/processor-flags.h
+++ b/arch/x86/include/uapi/asm/processor-flags.h
@@ -134,6 +134,8 @@
 #define X86_CR4_CET		_BITUL(X86_CR4_CET_BIT)
 #define X86_CR4_UINTR_BIT	25 /* enable User Interrupts support */
 #define X86_CR4_UINTR		_BITUL(X86_CR4_UINTR_BIT)
+#define X86_CR4_UFAULT_BIT	26 /* enable User Fault support */
+#define X86_CR4_UFAULT		_BITUL(X86_CR4_UFAULT_BIT)
 
 /*
  * x86-64 Task Priority Register, CR8
-- 
2.52.0

