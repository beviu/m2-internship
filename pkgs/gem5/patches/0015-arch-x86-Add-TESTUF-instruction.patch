From 0301cf3fcab62311dddddc43c3015fafea04e84e Mon Sep 17 00:00:00 2001
From: beviu <contact@beviu.com>
Date: Fri, 16 Jan 2026 13:53:53 +0100
Subject: [PATCH 15/20] arch-x86: Add TESTUF instruction

---
 src/arch/x86/isa/decoder/two_byte_opcodes.isa        |  1 +
 .../insts/general_purpose/compare_and_test/test.py   | 12 ++++++++++++
 2 files changed, 13 insertions(+)

diff --git a/src/arch/x86/isa/decoder/two_byte_opcodes.isa b/src/arch/x86/isa/decoder/two_byte_opcodes.isa
index c50d816a31..0cac00a6bd 100644
--- a/src/arch/x86/isa/decoder/two_byte_opcodes.isa
+++ b/src/arch/x86/isa/decoder/two_byte_opcodes.isa
@@ -137,6 +137,7 @@
                     0x3: decode MODRM_RM {
                         0x0: BasicOperate::SERIALIZE({{/*Nothing*/}},
                                                          IsSerializeAfter);
+                        0x1: Inst::TESTUF();
                         0x4: Inst::UIRET();
                         0x5: Inst::TESTUI();
                         0x6: Inst::CLUI();
diff --git a/src/arch/x86/isa/insts/general_purpose/compare_and_test/test.py b/src/arch/x86/isa/insts/general_purpose/compare_and_test/test.py
index 073913c597..7c001ea551 100644
--- a/src/arch/x86/isa/insts/general_purpose/compare_and_test/test.py
+++ b/src/arch/x86/isa/insts/general_purpose/compare_and_test/test.py
@@ -84,4 +84,16 @@ def macroop TESTUI
     or t5, t3, t4
     wruflags t5, t0, dataSize=8
 };
+
+def macroop TESTUF
+{
+    # ZF := AF := OF := PF := SF := 0;
+    # CF := UFF;
+    ruflags t1, dataSize=8
+    limm t2, "~((uint64_t)(CFBit | ZFBit | AFBit | OFBit | PFBit | SFBit))", dataSize=8
+    and t3, t1, t2, dataSize=8
+    rdval t4, ctrlRegIdx("misc_reg::Uff"), dataSize=8
+    or t5, t3, t4
+    wruflags t5, t0, dataSize=8
+};
 """
-- 
2.52.0

