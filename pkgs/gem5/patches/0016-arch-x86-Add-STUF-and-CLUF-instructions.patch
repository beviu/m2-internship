From 933b97f44d64854b88b2301a3cc4085df5aba7e7 Mon Sep 17 00:00:00 2001
From: beviu <contact@beviu.com>
Date: Mon, 5 Jan 2026 14:37:33 +0100
Subject: [PATCH 16/19] arch-x86: Add STUF and CLUF instructions

---
 src/arch/x86/isa/decoder/two_byte_opcodes.isa            | 2 ++
 .../x86/isa/insts/general_purpose/flags/set_and_clear.py | 9 +++++++++
 2 files changed, 11 insertions(+)

diff --git a/src/arch/x86/isa/decoder/two_byte_opcodes.isa b/src/arch/x86/isa/decoder/two_byte_opcodes.isa
index 0cac00a6bd..9df5298bec 100644
--- a/src/arch/x86/isa/decoder/two_byte_opcodes.isa
+++ b/src/arch/x86/isa/decoder/two_byte_opcodes.isa
@@ -138,6 +138,8 @@
                         0x0: BasicOperate::SERIALIZE({{/*Nothing*/}},
                                                          IsSerializeAfter);
                         0x1: Inst::TESTUF();
+                        0x2: Inst::CLUF();
+                        0x3: Inst::STUF();
                         0x4: Inst::UIRET();
                         0x5: Inst::TESTUI();
                         0x6: Inst::CLUI();
diff --git a/src/arch/x86/isa/insts/general_purpose/flags/set_and_clear.py b/src/arch/x86/isa/insts/general_purpose/flags/set_and_clear.py
index 4d302e23ae..3ac1efaf2c 100644
--- a/src/arch/x86/isa/insts/general_purpose/flags/set_and_clear.py
+++ b/src/arch/x86/isa/insts/general_purpose/flags/set_and_clear.py
@@ -184,4 +184,13 @@ def macroop STUI {
     limm t1, 1, dataSize=8
     wrval ctrlRegIdx("misc_reg::Uif"), t1, dataSize=8
 };
+
+def macroop CLUF {
+    wrval ctrlRegIdx("misc_reg::Uff"), t0, dataSize=8
+};
+
+def macroop STUF {
+    limm t1, 1, dataSize=8
+    wrval ctrlRegIdx("misc_reg::Uff"), t1, dataSize=8
+};
 """
-- 
2.52.0

