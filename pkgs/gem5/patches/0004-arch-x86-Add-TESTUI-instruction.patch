From 9b5aba21972d9943830350bf9536cfc4c94c8b4a Mon Sep 17 00:00:00 2001
From: beviu <contact@beviu.com>
Date: Thu, 15 Jan 2026 16:02:53 +0100
Subject: [PATCH 04/19] arch-x86: Add TESTUI instruction

---
 src/arch/x86/isa/decoder/two_byte_opcodes.isa         |  1 +
 .../insts/general_purpose/compare_and_test/test.py    | 11 +++++++++++
 2 files changed, 12 insertions(+)

diff --git a/src/arch/x86/isa/decoder/two_byte_opcodes.isa b/src/arch/x86/isa/decoder/two_byte_opcodes.isa
index 7cb212fcda..28dc5c6d07 100644
--- a/src/arch/x86/isa/decoder/two_byte_opcodes.isa
+++ b/src/arch/x86/isa/decoder/two_byte_opcodes.isa
@@ -137,6 +137,7 @@
                     0x3: decode MODRM_RM {
                         0x0: BasicOperate::SERIALIZE({{/*Nothing*/}},
                                                          IsSerializeAfter);
+                        0x5: Inst::TESTUI();
                     }
                 }
                 0x6: Inst::LMSW(Ew);
diff --git a/src/arch/x86/isa/insts/general_purpose/compare_and_test/test.py b/src/arch/x86/isa/insts/general_purpose/compare_and_test/test.py
index 8bff1e3cca..db776ec3d8 100644
--- a/src/arch/x86/isa/insts/general_purpose/compare_and_test/test.py
+++ b/src/arch/x86/isa/insts/general_purpose/compare_and_test/test.py
@@ -72,4 +72,15 @@ def macroop TEST_R_I
     limm t1, imm
     and t0, reg, t1, flags=(OF, SF, ZF, PF, CF, AF)
 };
+
+def macroop TESTUI
+{
+    # ZF := AF := OF := PF := SF := 0;
+    # CF := UIF;
+    ruflags t1, dataSize=8
+    andi t1, t1, "~((uint64_t)(CFBit | ZFBit | AFBit | OFBit | PFBit | SFBit))", dataSize=8
+    rdval t2, ctrlRegIdx("misc_reg::Uif"), dataSize=8
+    or t1, t1, t2
+    wruflags t1, t0, dataSize=8
+};
 """
-- 
2.52.0

